<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório Médico – Centro Médico TotalEnergies</title>
  <script src="https://cdn.tailwindcss.com "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js "></script>
  <style>
    .underline-input::after { content: '__________'; position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background: currentColor; opacity: 0.3; }
  </style>
</head>
<body class="bg-white text-gray-900 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-10 bg-white shadow-md">
    <div class="container mx-auto px-4 py-3 flex items-center">
      <div class="h-8 w-8 bg-blue-600 rounded mr-4"></div>
      <h1 class="text-lg font-bold">Relatório Médico – Centro Médico TotalEnergies</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 mt-16 pb-24 overflow-y-auto">
    <form id="reportForm" class="container mx-auto px-4 space-y-6">
      <!-- DOENTE Section -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">DOENTE</h2>
        <div class="space-y-3">
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Nome:</label>
            <input type="text" name="doente.nome" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Morada:</label>
            <input type="text" name="doente.morada" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Naturalidade:</label>
            <input type="text" name="doente.naturalidade" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Nacionalidade:</label>
            <input type="text" name="doente.nacionalidade" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">BI nº:</label>
            <input type="text" name="doente.bi" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Telefone:</label>
            <input type="tel" name="doente.telefone" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Data de Nasc.:</label>
            <input type="date" name="doente.dataNasc" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Profissão:</label>
            <input type="text" name="doente.profissao" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Raça:</label>
            <input type="text" name="doente.raca" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Sexo:</label>
            <input type="text" name="doente.sexo" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Nº de Processo:</label>
            <input type="text" id="processoInput" name="doente.processo" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
            <div id="qrcode" class="ml-2"></div>
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Cartão de Internamento nº:</label>
            <input type="text" name="doente.cartaoInternamento" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
        </div>
      </section>

      <!-- TRIAGEM Section -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">TRIAGEM</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Peso:</label>
            <input type="number" step="0.1" name="triagem.peso" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> kg
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Altura:</label>
            <input type="number" step="0.1" name="triagem.altura" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> cm
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Temperatura:</label>
            <input type="number" step="0.1" name="triagem.temperatura" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> °C
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Pulso:</label>
            <input type="number" name="triagem.pulso" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> bpm
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Frequência Respiratória:</label>
            <input type="number" name="triagem.frequenciaRespiratoria" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> rpm
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">TA:</label>
            <input type="number" name="triagem.taSistolica" class="w-16 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> / 
            <input type="number" name="triagem.taDiastolica" class="w-16 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> mmHg
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">Glicemia:</label>
            <input type="number" name="triagem.glicemia" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> mg/dL
          </div>
          <div class="flex items-baseline relative">
            <label class="w-20 text-sm">P. Cefálico:</label>
            <input type="number" step="0.1" name="triagem.perimetroCefalico" class="w-20 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___"> cm
          </div>
        </div>
      </section>

      <!-- INFORMAÇÃO CLÍNICA Section -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">INFORMAÇÃO CLÍNICA</h2>
        <div class="space-y-3">
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">ADMISSÃO - Idade:</label>
            <input type="number" name="informacaoClinica.idadeAdmissao" class="w-16 border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="___">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Raça:</label>
            <input type="text" name="informacaoClinica.racaAdmissao" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Data de Internamento:</label>
            <input type="date" name="informacaoClinica.dataInternamento" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Motivo Principal:</label>
            <input type="text" name="informacaoClinica.motivoPrincipal" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Queixas:</label>
            <textarea name="informacaoClinica.queixas" rows="3" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________"></textarea>
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">HISTÓRICO:</label>
            <textarea name="informacaoClinica.historico" rows="4" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="Evolução prévia, internações anteriores, medicações, etc."></textarea>
          </div>
        </div>
      </section>

      <!-- DIAGNÓSTICO PRELIMINAR -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">DIAGNÓSTICO PRELIMINAR</h2>
        <div class="flex items-baseline relative">
          <label class="w-32 text-sm">Diagnóstico:</label>
          <input type="text" name="diagnosticoPreliminar.diagnostico" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
        </div>
      </section>

      <!-- TRATAMENTO REALIZADO -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">TRATAMENTO REALIZADO</h2>
        <div class="space-y-3">
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Terapias em curso:</label>
            <input type="text" name="tratamentoRealizado.terapias" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
          <div class="flex items-baseline relative">
            <label class="w-32 text-sm">Medicamentos:</label>
            <input type="text" name="tratamentoRealizado.medicamentos" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
          </div>
        </div>
      </section>

      <!-- RECOMENDAÇÕES -->
      <section class="border-b pb-4">
        <h2 class="text-xl font-semibold mb-2">RECOMENDAÇÕES</h2>
        <div class="flex items-baseline relative">
          <label class="w-32 text-sm">Recomendações:</label>
          <input type="text" name="recomendacoes.texto" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
        </div>
      </section>

      <!-- DIAGNÓSTICO INICIAL -->
      <section>
        <h2 class="text-xl font-semibold mb-2">DIAGNÓSTICO INICIAL</h2>
        <div class="flex items-baseline relative">
          <label class="w-32 text-sm">Diagnóstico inicial:</label>
          <input type="text" name="diagnosticoInicial.diagnostico" class="w-full border-b border-gray-300 focus:ring-0 focus:border-blue-500 bg-transparent placeholder-gray-400" placeholder="__________">
        </div>
        <p class="mt-3 text-sm text-gray-600">OBS: Este relatório refere-se à avaliação inicial do paciente e não constitui alta médica. Acompanhamento regular é necessário; quadro em monitoramento constante.</p>
      </section>
    </form>
  </main>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 z-10 bg-white border-t shadow-md">
    <div class="container mx-auto px-4 py-2">
      <div class="flex justify-between text-sm">
        <span>Impresso a <span id="currentDate">2023-01-01</span> por Dr. João Silva</span>
        <span>Página 1 de 1</span>
      </div>
      <button id="emitButton" class="mt-2 w-full bg-blue-600 text-white py-3 rounded-full text-lg font-bold">Emitir</button>
    </div>
  </footer>

  <!-- Modal -->
  <div id="downloadModal" class="hidden fixed inset-0 z-20 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow-lg max-w-sm w-full">
      <h2 class="text-xl font-bold mb-4">Escolha o formato</h2>
      <div class="flex justify-around">
        <button id="downloadPDF" class="bg-red-600 text-white px-6 py-3 rounded-full text-lg">Baixar PDF</button>
        <button id="downloadDOCX" class="bg-blue-600 text-white px-6 py-3 rounded-full text-lg">Baixar DOCX</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="hidden fixed inset-0 z-30 bg-white bg-opacity-75 flex items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('reportForm');
      const emitButton = document.getElementById('emitButton');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const downloadModal = document.getElementById('downloadModal');
      const processoInput = document.getElementById('processoInput');
      const qrcodeContainer = document.getElementById('qrcode');
      const currentDateElement = document.getElementById('currentDate');

      // Set current date
      const today = new Date().toISOString().split('T')[0];
      currentDateElement.textContent = today;

      // Initialize form state
      let formData = {
        doente: {},
        triagem: {},
        informacaoClinica: {},
        diagnosticoPreliminar: {},
        tratamentoRealizado: {},
        recomendacoes: {},
        diagnosticoInicial: {}
      };

      // Load from localStorage
      const savedData = localStorage.getItem('medicalReportForm');
      if (savedData) {
        try {
          formData = JSON.parse(savedData);
        } catch (e) {
          console.error('Error parsing saved data', e);
        }
      }

      // Populate form fields
      function populateForm() {
        const inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          const name = input.name;
          if (name) {
            const keys = name.split('.');
            let value = formData;
            for (const key of keys) {
              if (value && typeof value === 'object' && key in value) {
                value = value[key];
              } else {
                value = undefined;
                break;
              }
            }
            if (input.type === 'checkbox') {
              input.checked = value === true;
            } else if (input.type === 'radio') {
              if (input.value === value) input.checked = true;
            } else {
              input.value = value || '';
            }
          }
        });
        // Generate QR code if processo exists
        if (formData.doente && formData.doente.processo) {
          processoInput.value = formData.doente.processo;
          generateQRCode(formData.doente.processo);
        }
      }

      populateForm();

      // Update formData on input change
      form.addEventListener('input', (event) => {
        const target = event.target;
        if (target.name) {
          const keys = target.name.split('.');
          let current = formData;
          while (keys.length > 1) {
            const key = keys.shift();
            if (!current[key]) current[key] = {};
            current = current[key];
          }
          const lastKey = keys[0];
          current[lastKey] = target.type === 'number' && target.value ? parseFloat(target.value) : target.value;
        }
      });

      // Generate QR code
      function generateQRCode(text) {
        qrcodeContainer.innerHTML = '';
        if (text) {
          new QRCode(qrcodeContainer, {
            text: text,
            width: 100,
            height: 100,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        }
      }

      processoInput.addEventListener('input', () => {
        generateQRCode(processoInput.value);
        // Update formData immediately
        if (!formData.doente) formData.doente = {};
        formData.doente.processo = processoInput.value;
      });

      // Autosave every 30 seconds
      setInterval(() => {
        localStorage.setItem('medicalReportForm', JSON.stringify(formData));
      }, 30000);

      // Handle form submission
      emitButton.addEventListener('click', async () => {
        // Validate form data
        const isValid = true; // Placeholder for validation logic
        if (!isValid) {
          alert('Por favor, preencha todos os campos obrigatórios.');
          return;
        }

        loadingSpinner.classList.remove('hidden');

        try {
          const response = await fetch('/generate-report', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });

          if (!response.ok) {
            throw new Error('Erro ao gerar relatório');
          }

          // Handle response as blob for download
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          
          loadingSpinner.classList.add('hidden');
          downloadModal.classList.remove('hidden');
          
          // Set up download handlers
          document.getElementById('downloadPDF').onclick = () => {
            const link = document.createElement('a');
            link.href = url;
            link.download = 'relatorio_medico.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };
          
          document.getElementById('downloadDOCX').onclick = () => {
            const link = document.createElement('a');
            link.href = url.replace('application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
            link.download = 'relatorio_medico.docx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };
        } catch (error) {
          console.error('Error:', error);
          alert('Ocorreu um erro ao gerar o relatório.');
          loadingSpinner.classList.add('hidden');
        }
      });
    });
  </script>
</body>
</html>